{% extends "base.html" %}
{% import "partials/icons.html" as icons %}

{% block content %}
<div class="layout">
  <section class="palette-panel">
    <div class="panel-header">Blocks</div>
    <div class="palette-controls">
      <button type="button" class="btn quick-task-btn" id="quick-task-btn">+ Quick task</button>
      <button type="button" class="btn recurring-task-btn" id="recurring-task-btn">üîÑ Recurring</button>
      <input type="text" id="block-search" placeholder="Search blocks..." class="search-input" />
      <select id="duration-select" class="duration-select">
        {% for d in duration_options %}
          <option value="{{d}}" {% if d == 60 %}selected{% endif %}>{% if d >= 60 %}{{"%d:%02dh" % (d//60, d%60)}}{% else %}{{d}}m{% endif %}</option>
        {% endfor %}
      </select>
    </div>
    <div class="palette-scroll">
      {% include "partials/palette.html" %}
    </div>
    <button type="button" class="btn add-block-btn" id="add-block-btn">+ Add block</button>
  </section>

  <section class="planner-panel">
    <div class="planner-header">
      <div class="legends">
        <div class="legend"><span class="dot prod"></span>Production</div>
        <div class="legend"><span class="dot act"></span>Activity</div>
        <div class="legend"><span class="dot night"></span>Night</div>
      </div>
      <div class="week-nav-wrapper">
        <span class="week-label">
          Week of {{week_start.strftime('%b %d, %Y')}}
        </span>
        <div class="week-nav">
          <a href="/?week={{prev_week}}" class="week-btn" title="Previous week">‚óÇ</a>
          <a href="/?week={{next_week}}" class="week-btn" title="Next week">‚ñ∏</a>
          <a href="/" class="week-btn today-btn" title="Go to today">Today</a>
        </div>
      </div>
      <div class="plan-controls">
        <div class="plan-selector">
          <span class="plan-label">View:</span>
          <div class="plan-checkboxes" id="plan-view-selector">
            {% for plan in plans %}
            <label class="plan-checkbox" style="--plan-color: {{plan.color}}">
              <input type="checkbox" value="{{plan.id}}" {% if plan.id in selected_plan_ids %}checked{% endif %}>
              <span class="plan-chip">{{plan.name}}</span>
            </label>
            {% endfor %}
          </div>
        </div>
        <div class="plan-selector">
          <span class="plan-label">Add to:</span>
          <select id="active-plan-select" class="plan-select">
            {% for plan in plans %}
            <option value="{{plan.id}}" {% if loop.first %}selected{% endif %}>{{plan.name}}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="settings-dropdown" id="settings-dropdown">
        <button type="button" class="settings-btn" id="settings-btn" title="Settings">‚öôÔ∏è</button>
        <div class="settings-menu" id="settings-menu">
          <button type="button" class="settings-item" id="manage-plans-btn">üìã Manage Plans</button>
          <a href="/export/csv" class="settings-item">üì• Export Data</a>
          <button type="button" class="settings-item" id="import-btn">üì§ Import Data</button>
        </div>
        <input type="file" id="import-file" accept=".zip" style="display:none;">
      </div>
    </div>
    <div class="schedule-scroll-container">
      <div>
        {% include "partials/schedule.html" %}
      </div>
    </div>
  </section>
</div>

<div class="quick-task-modal" id="quick-task-modal" aria-hidden="true">
  <div class="quick-task-overlay" data-close-modal></div>
  <div class="quick-task-card" role="dialog" aria-modal="true" aria-labelledby="quick-task-title">
    <div class="quick-task-header">
      <div>
        <div class="quick-task-eyebrow">Fast capture</div>
        <h2 id="quick-task-title">Add quick task</h2>
      </div>
      <button type="button" class="quick-task-close" data-close-modal aria-label="Close">√ó</button>
    </div>
    <form id="quick-task-form"
          class="quick-task-form"
          hx-post="/quick-task"
          hx-target="#schedule"
          hx-swap="outerHTML">
      <label>
        Task label
        <input type="text" name="title" maxlength="80" placeholder="What needs doing?" required />
      </label>
      <div class="quick-task-grid">
        <label>
          Day
          <select name="day" required>
            {% for d in day_order %}
              <option value="{{d}}" {% if week_dates[loop.index0].is_today %}selected{% endif %}>{{d}}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          Start time
          <input type="time" name="start_time" value="09:00" step="900" required />
        </label>
      </div>
      <p class="quick-task-hint">Creates a 1h gray block you can drag or resize later.</p>
      <input type="hidden" name="week" value="{{week_start}}" />
      <input type="hidden" name="plan_id" id="quick-task-plan-id" value="" />
      <div class="quick-task-actions">
        <button type="button" class="btn ghost" data-close-modal>Cancel</button>
        <button type="submit" class="btn">Add task</button>
      </div>
    </form>
  </div>
</div>

<div class="entry-note-modal" id="entry-note-modal" aria-hidden="true">
  <div class="entry-note-overlay" data-note-close></div>
  <div class="entry-note-shell" id="entry-note-content"></div>
</div>

<div class="add-block-modal" id="add-block-modal" aria-hidden="true">
  <div class="add-block-overlay" data-block-close></div>
  <div class="add-block-card" role="dialog" aria-modal="true" aria-labelledby="add-block-title">
    <div class="add-block-header">
      <div>
        <div class="add-block-eyebrow">New template</div>
        <h2 id="add-block-title">Create block type</h2>
      </div>
      <button type="button" class="add-block-close" data-block-close aria-label="Close">√ó</button>
    </div>
    <form id="add-block-form"
          class="add-block-form"
          hx-post="/blocks"
          hx-target="#palette"
          hx-swap="outerHTML">
      <label>
        Label
        <input type="text" name="name" maxlength="60" placeholder="e.g. Meeting, Deep work..." required />
      </label>
      <label>
        Color
        <input type="color" name="color" value="#0ea5e9" />
      </label>
      <label>
        Icon
        {% set default_icon = icon_choices[0].name if icon_choices else 'calendar' %}
        <div class="icon-picker" data-selected-class="is-selected">
          <input type="hidden" name="icon" value="{{default_icon}}" />
          <div class="icon-options">
            {% for icon in icon_choices %}
              <button type="button" class="icon-option {% if icon.name == default_icon %}is-selected{% endif %}" data-icon="{{icon.name}}">
                <span class="icon-preview">{{ icons.render(icon.name, 18, "var(--text)") }}</span>
                <span class="icon-label">{{ icon.label }}</span>
              </button>
            {% endfor %}
          </div>
        </div>
      </label>
      <div class="add-block-actions">
        <button type="button" class="btn ghost" data-block-close>Cancel</button>
        <button type="submit" class="btn">Create block</button>
      </div>
    </form>
  </div>
</div>

<div class="recurring-task-modal" id="recurring-task-modal" aria-hidden="true">
  <div class="recurring-task-overlay" data-recurring-close></div>
  <div class="recurring-task-card" role="dialog" aria-modal="true" aria-labelledby="recurring-task-title">
    <div class="recurring-task-header">
      <div>
        <div class="recurring-task-eyebrow">Repeat schedule</div>
        <h2 id="recurring-task-title">Create recurring task</h2>
      </div>
      <button type="button" class="recurring-task-close" data-recurring-close aria-label="Close">√ó</button>
    </div>
    <form id="recurring-task-form"
          class="recurring-task-form"
          hx-post="/recurring-tasks"
          hx-target="#schedule"
          hx-swap="outerHTML">
      <label>
        Task label
        <input type="text" name="title" maxlength="80" placeholder="What repeats?" required />
      </label>
      <label>
        Block type
        <select name="block_type_id" required>
          {% for block in blocks %}
            <option value="{{block.id}}">{{block.name}}</option>
          {% endfor %}
        </select>
      </label>
      <div class="recurring-task-grid">
        <label>
          Repeats
          <select name="pattern" id="recurring-pattern" required>
            <option value="daily">Daily</option>
            <option value="weekly" selected>Weekly</option>
            <option value="monthly">Monthly</option>
          </select>
        </label>
        <label>
          Every
          <input type="number" name="interval" value="1" min="1" max="52" required />
        </label>
      </div>
      <div class="recurring-task-grid" id="recurring-day-picker">
        <label id="day-of-week-label">
          Day of week
          <select name="day_of_week">
            {% for i, d in [(0, "Monday"), (1, "Tuesday"), (2, "Wednesday"), (3, "Thursday"), (4, "Friday"), (5, "Saturday"), (6, "Sunday")] %}
              <option value="{{i}}">{{d}}</option>
            {% endfor %}
          </select>
        </label>
        <label id="day-of-month-label" style="display: none;">
          Day of month
          <input type="number" name="day_of_month" value="1" min="1" max="31" />
        </label>
      </div>
      <div class="recurring-task-grid">
        <label>
          Start time
          <input type="time" name="start_time" value="09:00" step="900" required />
        </label>
        <label>
          Duration
          <select name="duration_minutes" required>
            {% for d in duration_options %}
              <option value="{{d}}" {% if d == 60 %}selected{% endif %}>{% if d >= 60 %}{{"%d:%02dh" % (d//60, d%60)}}{% else %}{{d}}m{% endif %}</option>
            {% endfor %}
          </select>
        </label>
      </div>
      <div class="recurring-task-grid">
        <label>
          Starts on
          <input type="date" name="start_date" value="{{week_start}}" />
        </label>
        <label>
          Ends on <span class="hint">(optional)</span>
          <input type="date" name="end_date" />
        </label>
      </div>
      <label>
        Note <span class="hint">(optional)</span>
        <input type="text" name="note" maxlength="255" placeholder="Additional details..." />
      </label>
      <input type="hidden" name="week" value="{{week_start}}" />
      <input type="hidden" name="plan_id" id="recurring-task-plan-id" value="" />
      <div class="recurring-task-actions">
        <button type="button" class="btn ghost" data-recurring-close>Cancel</button>
        <button type="submit" class="btn">Create recurring task</button>
      </div>
    </form>
  </div>
</div>

<div class="recurring-confirm-modal" id="recurring-confirm-modal" aria-hidden="true">
  <div class="recurring-confirm-overlay" data-confirm-close></div>
  <div class="recurring-confirm-card" role="alertdialog" aria-modal="true" aria-labelledby="recurring-confirm-title">
    <h3 id="recurring-confirm-title">Recurring Task</h3>
    <p id="recurring-confirm-message">What would you like to do?</p>
    <div class="recurring-confirm-actions">
      <button type="button" class="btn ghost" data-confirm-close>Cancel</button>
      <button type="button" class="btn" id="recurring-confirm-single">This instance only</button>
      <button type="button" class="btn" id="recurring-confirm-all">All instances</button>
    </div>
  </div>
</div>

<div class="confirm-modal" id="confirm-modal" aria-hidden="true">
  <div class="confirm-overlay" data-generic-confirm-close></div>
  <div class="confirm-card" role="alertdialog" aria-modal="true" aria-labelledby="confirm-title">
    <h3 id="confirm-title">Confirm</h3>
    <p id="confirm-message">Are you sure?</p>
    <div class="confirm-actions">
      <button type="button" class="btn ghost" data-generic-confirm-close>Cancel</button>
      <button type="button" class="btn danger" id="confirm-ok">Delete</button>
    </div>
  </div>
</div>

<div class="plans-modal" id="plans-modal" aria-hidden="true">
  <div class="plans-overlay" data-plans-close></div>
  <div class="plans-card" role="dialog" aria-modal="true" aria-labelledby="plans-title">
    <div class="plans-header">
      <h2 id="plans-title">Manage Plans</h2>
      <button type="button" class="plans-close" data-plans-close aria-label="Close">√ó</button>
    </div>
    <div class="plans-content" id="plans-list" hx-get="/plans" hx-trigger="plans-changed from:body">
      Loading...
    </div>
    <form class="plans-add-form" id="plans-add-form" hx-post="/plans" hx-target="#plans-list" hx-swap="innerHTML">
      <input type="text" name="name" placeholder="New plan name..." required maxlength="50" />
      <input type="color" name="color" value="#0ea5e9" />
      <button type="submit" class="btn">+ Add</button>
    </form>
  </div>
</div>
{% endblock %}
