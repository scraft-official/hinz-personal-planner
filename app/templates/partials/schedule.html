{% import "partials/icons.html" as icons %}
{% set total_slots = ((day_end - day_start) / slot_minutes) | int %}
{% set grid_height = total_slots * slot_height %}
{% set multi_plan = (plans|length > 1) and (selected_plan_ids|length > 1) %}
<div class="schedule-wrapper {% if multi_plan %}multi-plan-view{% endif %}" id="schedule" data-day-start="{{day_start}}" data-day-end="{{day_end}}" data-slot-minutes="{{slot_minutes}}" data-slot-height="{{slot_height}}" data-day-order="{{ day_order | join(',') }}" data-week-start="{{week_start}}" data-is-current-week="{{is_current_week|lower}}" data-plans="{{plans|map(attribute='id')|list|join(',')}}">
  <div class="time-col">
    <div class="periods">
      {% for p in periods %}
        {% set height = ((p.end - p.start) / slot_minutes) * slot_height %}
        {% set top = ((p.start - day_start) / slot_minutes) * slot_height %}
        <div class="period-segment {{p.class}}" style="top: {{top}}px; height: {{height}}px;">
          <span>{{p.name}}</span>
        </div>
      {% endfor %}
    </div>
    {% for m in range(day_start, day_end+1, 60) %}
      <div class="time-label" style="height: {{(60/slot_minutes)*slot_height}}px;">
        {{"%02d:%02d" % (m//60, m%60)}}
      </div>
    {% endfor %}
  </div>
  <div class="grid-cols">
    <div class="grid-header">
      {% for wd in week_dates %}
        <div class="day-head {% if wd.is_today %}is-today{% endif %}">
          <span class="day-name">{{wd.name[:3]}}</span>
          <span class="day-date">{{wd.date.day}}</span>
        </div>
      {% endfor %}
    </div>
    {% if is_current_week and current_time_top is defined and current_time_top >= 0 %}
      <div class="current-time-line" style="top: {{current_time_top + 28}}px;"></div>
    {% endif %}
    <div class="grid-body" style="height: {{grid_height}}px;">
      {% for wd in week_dates %}
        {% set day = wd.name %}
        {% set prod_height = ((periods[0].end - periods[0].start) / slot_minutes) * slot_height %}
        {% set act_top = ((periods[1].start - day_start) / slot_minutes) * slot_height %}
        {% set act_height = ((periods[1].end - periods[1].start) / slot_minutes) * slot_height %}
        {% set night_top = ((periods[2].start - day_start) / slot_minutes) * slot_height %}
        {% set night_height = ((periods[2].end - periods[2].start) / slot_minutes) * slot_height %}
        <div class="day-col {% if wd.is_today %}is-today{% endif %}" data-day="{{day}}" style="height: {{grid_height}}px;">
          <div class="day-period prod" style="top: 0; height: {{prod_height}}px;"></div>
          <div class="day-period act" style="top: {{act_top}}px; height: {{act_height}}px;"></div>
          <div class="day-period night" style="top: {{night_top}}px; height: {{night_height}}px;"></div>
          {% for entry in entries_by_day.get(day, []) %}
            {% if entry is mapping %}
              {# This is a recurring task instance (dict) #}
              {% set is_recurring = true %}
              {% set entry_start = entry.start_minute %}
              {% set entry_duration = entry.duration_minutes %}
              {% set entry_day = entry.day %}
              {% set entry_color = entry.block_type.color %}
              {% set entry_icon = entry.block_type.icon %}
              {% set display_name = entry.title %}
              {% set entry_note = entry.note %}
              {% set recurring_task_id = entry.recurring_task_id %}
              {% set instance_date = entry.instance_date %}
              {% set entry_plan_id = entry.plan_id %}
            {% else %}
              {# This is a regular ScheduleEntry #}
              {% set is_recurring = false %}
              {% set entry_start = entry.start_minute %}
              {% set entry_duration = entry.duration_minutes %}
              {% set entry_day = entry.day %}
              {% set entry_color = entry.block_type.color %}
              {% set entry_icon = entry.block_type.icon %}
              {% set display_name = entry.custom_title or entry.block_type.name %}
              {% set entry_note = entry.note %}
              {% set recurring_task_id = none %}
              {% set instance_date = none %}
              {% set entry_plan_id = entry.plan_id %}
            {% endif %}
            {% set top = ((entry_start - day_start) / slot_minutes) * slot_height %}
            {% set height = (entry_duration / slot_minutes) * slot_height %}
            {% set end_minute = entry_start + entry_duration %}
            {% set start_time = "%02d:%02d" % (entry_start//60, entry_start%60) %}
            {% set end_time = "%02d:%02d" % (end_minute//60, end_minute%60) %}
            {% set dur_h = entry_duration // 60 %}
            {% set dur_m = entry_duration % 60 %}
            {% set dur_str = ("%dh %02dm" % (dur_h, dur_m)) if dur_h else ("%dm" % dur_m) %}
            {% set tooltip = display_name ~ " Â· " ~ start_time ~ " â€“ " ~ end_time ~ " (" ~ dur_str ~ ")" %}
            {% if is_recurring %}{% set tooltip = "ðŸ”„ " ~ tooltip %}{% endif %}
            {# Find plan color for indicator #}
            {% set ns = namespace(plan_color=none) %}
            {% if entry_plan_id %}
              {% for plan in plans %}
                {% if plan.id == entry_plan_id %}
                  {% set ns.plan_color = plan.color %}
                {% endif %}
              {% endfor %}
            {% endif %}
            {% if entry_note %}{% set tooltip = tooltip ~ "\n" ~ entry_note %}{% endif %}
            <div class="entry {% if height < 36 %}compact{% endif %} {% if is_recurring %}recurring{% endif %}" 
                 {% if is_recurring %}
                   data-recurring-task-id="{{recurring_task_id}}"
                   data-instance-date="{{instance_date}}"
                 {% else %}
                   data-entry-id="{{entry.id}}"
                 {% endif %}
                 data-start-minute="{{entry_start}}" 
                 data-end-minute="{{end_minute}}"
                 data-duration="{{entry_duration}}" 
                 data-day="{{entry_day}}"
                 data-color="{{entry_color}}"
                 data-computed-top="{{top}}"
                 data-tooltip="{{tooltip}}"
                 data-is-recurring="{{is_recurring|lower}}"
                 data-plan-id="{{entry_plan_id or ''}}"
                 style="top: {{top|int}}px; height: {{height|int}}px; border-color: {{entry_color}}; background: {{entry_color}}30; --plan-color: {{ns.plan_color or 'transparent'}};"
                 aria-label="{{tooltip}}"
                 tabindex="0">
              <div class="entry-bar {% if is_recurring %}striped{% endif %}" style="background: {{entry_color}};"></div>
              <div class="entry-content">
                <div class="entry-title">{{ icons.render(entry_icon, 12, entry_color) }} <span class="entry-title-text" {% if is_recurring %}data-recurring-task-id="{{recurring_task_id}}" data-instance-date="{{instance_date}}"{% else %}data-entry-id="{{entry.id}}"{% endif %}>{{display_name}}</span></div>
                <div class="entry-meta">{{start_time}} â€“ {{end_time}}</div>
                {% if entry_note %}<div class="entry-note">{{entry_note}}</div>{% endif %}
              </div>
              <button type="button" class="entry-delete-btn" {% if is_recurring %}data-recurring-task-id="{{recurring_task_id}}" data-instance-date="{{instance_date}}"{% else %}data-entry-id="{{entry.id}}"{% endif %} aria-label="Delete">Ã—</button>
              <div class="entry-resize-handle" title="Drag to resize"></div>
            </div>
          {% endfor %}
        </div>
      {% endfor %}
    </div>
  </div>
</div>
